<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Multiplayer game</title>
	<style>
		span {
			font-style: italic;
		}
		#start:not([hidden]), #play:not([hidden]) {
			display: flex;
			justify-content: center;
		}
		#chatbox {
			border: 1px solid black;
			display: flex;
			flex-direction: column-reverse;
			position: absolute;
			top: 0;
			bottom: 20px;
			left: 0;
			right: 0;
			overflow: auto;
		}
		#chatcontainer {
			position: relative;
			width: 25%;
		}
		canvas {
			width: 75%;
			border: 5px solid rgb(0, 255, 0);
		}
		#chatinput {
			position: absolute;
			bottom: 0;
			width: -moz-available;
			width: -webkit-fill-available;
		}
		#chatbox p {
			margin: 0.5em;
		}
	</style>
</head>

<body>
	<div id="play" hidden>
		<canvas width="3000" height="2000"></canvas>
		<div id="chatcontainer">
			<div id="chatbox"></div>
			<input id="chatinput">
		</div>
	</div>
	<div id="start">
		<label>Choose a display name: <input id="displayname"></label>
	</div>
</body>

<script>
	'use strict';

	const [chatbox, chatinput, usernameinput, play, start_screen] =
		['chatbox', 'chatinput', 'displayname', 'play', 'start']
			.map(document.getElementById.bind(document)),
		keys = new Set([
			'ArrowUp',
			'ArrowLeft',
			'ArrowDown',
			'ArrowRight'
		]),
		keys_down = new Set,
		max_y = 2000 / 2,
		max_x = 3000 / 2;

	usernameinput.value = localStorage.display_name || '';
	usernameinput.select();
	usernameinput.addEventListener('keypress', ({ key }) => {
		if (key === 'Enter') start();
	});

	class Game {
		players = new Map;

		constructor(canvas, ws) {
			this.ctx = canvas.getContext('2d');
			this.ctx.imageSmoothingEnabled = false;
			this.ctx.textAlign = 'center';
			this.ctx.font = '50px arial';

			document.addEventListener('keydown', e => handle_key(e, true));
			document.addEventListener('keyup', e => handle_key(e, false));

			this.players.set_property = function (id, property, value) {
				const player = this.get(id);
				if (player) player[property] = value;
				else this.set(id, { [property]: value });
			}

			function handle_key(event, is_down) {
				if (keys.has(event.code)) {
					event.preventDefault();
					keys_down[is_down ? 'add' : 'delete'](event.code);
					let x = 0, y = 0;
					if (keys_down.has('ArrowUp'))    y--;
					if (keys_down.has('ArrowLeft'))  x--;
					if (keys_down.has('ArrowDown'))  y++;
					if (keys_down.has('ArrowRight')) x++;
					ws.send(JSON.stringify({ type: 'position', x, y }));
				} else if (event.target !== chatinput) chatinput.select();
			}
		}

		update() {
			this.ctx.save();
			this.ctx.setTransform(1, 0, 0, 1, 0, 0);
			this.ctx.clearRect(0, 0, 2 * max_x, 2 * max_y);
			this.ctx.restore();

			for (const { position, color } of this.players.values()) {
				if (!position) continue;
				this.ctx.fillStyle = color || '#000000';
				this.ctx.beginPath();
				this.ctx.arc(...position, 50, 0, 2 * Math.PI);
				this.ctx.fill();
			}

			this.ctx.globalAlpha = 0.75;
			for (const { username, position, color } of this.players.values()) {
				if (!position || !username) continue;
				this.ctx.fillStyle = color || '#000000';
				this.ctx.fillText(username, position[0], position[1] - 60);
			}
			this.ctx.fillStyle = '#000000';
			this.ctx.globalAlpha = 1;
		}
	}

	function start() {
		play.hidden = false;
		start_screen.hidden = true;
		const ws = new WebSocket(
			`ws://${
				location.hostname
			}:${
				window.location.port ||
					(window.location.protocol === 'http:' ? '80' : '443')
			}/?username=${
				encodeURIComponent(localStorage.display_name = usernameinput.value)
			}`);

		const game = new Game(document.querySelector('canvas'), ws);

		ws.onmessage = ({ data }) => {
			const { type, message, username, color, id } = JSON.parse(data);
			if (type === 'message') {
				append_chat(message, game.players.get(id).username);
			} else if (type === 'position') {
				if (username !== undefined) {
					game.players.set_property(id, 'username', username);
				}
				if (color) game.players.set_property(id, 'color', color);
				if (id === game.my_id) {
					game.ctx.setTransform(1, 0, 0, 1,
						max_x - message[0],
						max_y - message[1]);
				}
				game.players.set_property(id, 'position', message);
				game.update();
			} else if (type === 'id') {
				game.my_id = id;
				game.players.set_property(id, 'username', usernameinput.value);
			} else if (type === 'bye') {
				game.players.delete(id);
				game.update();
			}
		}

		chatinput.addEventListener('keypress', ({ key }) => {
			if (key === 'Enter') {
				ws.send(JSON.stringify({
					type: 'message',
					message: chatinput.value
				}));
				append_chat(chatinput.value);
				chatinput.value = '';
			}
		});

		function append_chat(text, username) {
			const elem = document.createElement('p');
			const name = document.createElement(username === undefined ? 'span' : 'b');
			name.textContent = (username === undefined ? '(You)' : username) + ': ';
			elem.appendChild(name);
			elem.insertAdjacentText('beforeend', text);
			chatbox.prepend(elem);
		}
	}
</script>

</html>